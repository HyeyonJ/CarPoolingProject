<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">        
<mapper namespace="project.carPooling.passenger.mapper.ReservationListMapper">
	<select id="selectCurrentList" resultType="map">
		SELECT (SELECT d_user_name FROM DRIVER WHERE d_idx = dr.d_idx) "D_USER_NAME", 
		dr.dr_idx, dr.d_commute, dr.d_date, dr.d_start_time, dr.d_end_time, dr.d_start_point, dr.d_end_point, dr.d_start_lon, dr.d_start_lat, dr.d_end_lon, dr.d_end_lat, dr.d_fee,  r.r_idx, r.r_date
		FROM d_registration dr, reservation r
		WHERE r.p_idx=#{pIdx} AND dr.dr_idx = r.dr_idx 
		AND to_date(to_char(dr.d_date, 'yymmdd')||substr(dr.d_start_time, 0, 2)||substr(dr.d_end_time, 4,5), 'yymmddhh24mi') >= sysdate
	</select>
	
	<select id="selectPastList" resultType="map">
		SELECT (SELECT d_user_name FROM DRIVER WHERE d_idx = dr.d_idx) "D_USER_NAME",
		dr.dr_idx, dr.d_commute, dr.d_date, dr.d_start_time, dr.d_end_time, dr.d_start_point, dr.d_end_point, dr.d_start_lon, dr.d_start_lat, dr.d_end_lon, dr.d_end_lat, dr.d_fee, r.r_idx, r.r_date
		FROM d_registration dr, reservation r
		WHERE r.p_idx=#{pIdx} AND dr.dr_idx = r.dr_idx 
		AND to_date(to_char(dr.d_date, 'yymmdd')||substr(dr.d_start_time, 0, 2)||substr(dr.d_end_time, 4,5), 'yymmddhh24mi') <![CDATA[<]]> sysdate
	</select>
	
	<delete id="deleteRsv">
		DELETE FROM RESERVATION
		WHERE dr_idx = #{drIdx} AND p_idx = #{pIdx}
	</delete>
	
	<select id="selectDriverEmail" resultType="String">
		SELECT d_user_email
		FROM DRIVER
		WHERE d_idx = 
		(SELECT d_idx
		FROM D_REGISTRATION
		WHERE dr_idx = #{drIdx})
	</select>
	
	<update id="updateDriverPoint">
		UPDATE DRIVER
		SET d_point = d_point + #{point}
		WHERE d_idx = #{dIdx}
	</update>
	
	<update id="updateReservatedToWaiting">
		UPDATE D_REGISTRATION
		SET d_reservation_status = 'waiting'
		WHERE dr_idx = #{drIdx}
	</update>
	
	<delete id="deleteReservation">
		DELETE FROM RESERVATION
		WHERE dr_idx = #{drIdx}
	</delete>
	
	<select id="selectRegistrationByDrIdx" resultType="DRegistration">
		SELECT *
		FROM D_REGISTRATION
		WHERE dr_idx = #{drIdx}
	</select>
</mapper>